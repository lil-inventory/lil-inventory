<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">

    <!-- Authentication -->
    <changeSet author="isaiah" id="1.0.1">
        <createTable tableName="user">
            <column name="user_id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" unique="true"/>
            </column>
            <column name="user_email" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="email_verified" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="display_name" type="VARCHAR(127)">
                <constraints nullable="false"/>
            </column>
            <column name="salt" type="VARCHAR(255)"/>
            <column name="password" type="VARCHAR(255)"/>
        </createTable>
    </changeSet>

    <changeSet author="isaiah" id="1.0.2">
        <createTable tableName="user_session">
            <column name="user_session_id" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false" unique="true"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="jwt_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="expiration" type="DATETIME">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet  author="isaiah"  id="1.0.3">
        <addForeignKeyConstraint
                baseColumnNames="user_id"
                baseTableName="user_session"
                constraintName="fk_user_session_user"
                onDelete="CASCADE"
                onUpdate="RESTRICT"
                referencedColumnNames="user_id"
                referencedTableName="user"
        />
    </changeSet>

    <changeSet author="isaiah" id="1.0.4">
        <createTable tableName="user_email_verification">
            <column name="user_email_verification_id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" unique="true" />
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="salt" type="VARCHAR(255)">
                <constraints nullable="false" />
            </column>
            <column name="code" type="VARCHAR(255)">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet  author="isaiah"  id="1.0.5">
        <addForeignKeyConstraint
                baseColumnNames="user_id"
                baseTableName="user_email_verification"
                constraintName="fk_user_email_verification_user"
                onDelete="CASCADE"
                onUpdate="RESTRICT"
                referencedColumnNames="user_id"
                referencedTableName="user"
        />
    </changeSet>

    <changeSet author="isaiah" id="1.0.6">
        <createTable tableName="user_password_reset">
            <column name="user_password_reset_id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" unique="true" />
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="salt" type="VARCHAR(255)">
                <constraints nullable="false" />
            </column>
            <column name="code" type="VARCHAR(255)">
                <constraints nullable="false" />
            </column>
            <column name="expiration" type="DATETIME">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet  author="isaiah"  id="1.0.7">
        <addForeignKeyConstraint
                baseColumnNames="user_id"
                baseTableName="user_password_reset"
                constraintName="fk_user_password_reset_user"
                onDelete="CASCADE"
                onUpdate="RESTRICT"
                referencedColumnNames="user_id"
                referencedTableName="user"
        />
    </changeSet>

    <!-- Inventory -->
    <changeSet author="isaiah" id="1.0.8">
        <createTable tableName="inventory">
            <column name="inventory_id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" unique="true"/>
            </column>
            <column name="name" type="VARCHAR(127)">
                <constraints nullable="false"/>
            </column>
            <column name="owner_user_id" type="BIGINT(127)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="isaiah" id="1.0.9">
        <createTable tableName="inventory_user">
            <column name="inventory_user_id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" unique="true"/>
            </column>
            <column name="inventory_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="read" type="BOOLEAN" defaultValue="false">
                <constraints nullable="false"/>
            </column>
            <column name="write" type="BOOLEAN" defaultValue="false">
                <constraints nullable="false"/>
            </column>
            <column name="admin" type="BOOLEAN" defaultValue="false">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet  author="isaiah"  id="1.0.10">
        <addForeignKeyConstraint
                baseColumnNames="inventory_id"
                baseTableName="inventory_user"
                constraintName="fk_inventory_user_inventory"
                onDelete="CASCADE"
                onUpdate="RESTRICT"
                referencedColumnNames="inventory_id"
                referencedTableName="inventory"
        />
    </changeSet>

    <changeSet  author="isaiah"  id="1.0.11">
        <addForeignKeyConstraint
                baseColumnNames="user_id"
                baseTableName="inventory_user"
                constraintName="fk_inventory_user_user"
                onDelete="CASCADE"
                onUpdate="RESTRICT"
                referencedColumnNames="user_id"
                referencedTableName="user"
        />
    </changeSet>

    <changeSet author="isaiah" id="1.0.12">
        <createTable tableName="group">
            <column name="group_id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" unique="true"/>
            </column>
            <column name="inventory_id" type="BIGINT" >
                <constraints nullable="false"/>
            </column>
            <column name="parent_group_id" type="BIGINT" />
            <column name="name" type="VARCHAR(127)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet  author="isaiah"  id="1.0.13">
        <addForeignKeyConstraint
                baseColumnNames="inventory_id"
                baseTableName="group"
                constraintName="fk_group_inventory"
                onDelete="CASCADE"
                onUpdate="RESTRICT"
                referencedColumnNames="inventory_id"
                referencedTableName="inventory"
        />
    </changeSet>

    <changeSet  author="isaiah"  id="1.0.14">
        <addForeignKeyConstraint
                baseColumnNames="parent_group_id"
                baseTableName="group"
                constraintName="fk_group_group"
                onDelete="RESTRICT"
                onUpdate="RESTRICT"
                referencedColumnNames="group_id"
                referencedTableName="group"
        />
    </changeSet>

    <changeSet author="isaiah" id="1.0.15">
        <createTable tableName="asset">
            <column name="asset_id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" unique="true"/>
            </column>
            <column name="inventory_id" type="BIGINT" >
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(127)">
                <constraints nullable="false"/>
            </column>
            <column name="asset_type" type="VARCHAR(32)" >
                <constraints nullable="false"/>
            </column>
            <column name="barcode" type="VARCHAR(255)" />
            <column name="quantity" type="INT" >
                <constraints nullable="false" />
            </column>
            <column name="quantity_minimum" type="INT" />
            <column name="group_id" type="BIGINT" />
        </createTable>
    </changeSet>

    <changeSet author="isaiah" id="1.0.16">
        <sql>
            ALTER TABLE `asset`
            ADD CONSTRAINT chk_quantity CHECK (`quantity` >= 0);
        </sql>
        <rollback>
            ALTER TABLE `asset`
            DROP CONSTRAINT chk_quantity;
        </rollback>
    </changeSet>

    <changeSet  author="isaiah"  id="1.0.17">
        <addForeignKeyConstraint
                baseColumnNames="inventory_id"
                baseTableName="asset"
                constraintName="fk_asset_inventory"
                onDelete="CASCADE"
                onUpdate="RESTRICT"
                referencedColumnNames="inventory_id"
                referencedTableName="inventory"
        />
    </changeSet>

    <changeSet  author="isaiah"  id="1.0.18">
        <addForeignKeyConstraint
                baseColumnNames="group_id"
                baseTableName="asset"
                constraintName="fk_asset_group"
                onDelete="CASCADE"
                onUpdate="RESTRICT"
                referencedColumnNames="group_id"
                referencedTableName="group"
        />
    </changeSet>

    <changeSet author="isaiah" id="1.0.19">
        <createTable tableName="checkout">
            <column name="checkout_id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" unique="true"/>
            </column>
            <column name="asset_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="notes" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="timestamp" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet  author="isaiah"  id="1.0.20">
        <addForeignKeyConstraint
                baseColumnNames="asset_id"
                baseTableName="checkout"
                constraintName="fk_checkout_asset"
                onDelete="CASCADE"
                onUpdate="RESTRICT"
                referencedColumnNames="asset_id"
                referencedTableName="asset"
        />
    </changeSet>

    <changeSet author="isaiah" id="1.0.21">
        <addForeignKeyConstraint
                baseColumnNames="user_id"
                baseTableName="checkout"
                constraintName="fk_checkout_user"
                onDelete="CASCADE"
                onUpdate="RESTRICT"
                referencedColumnNames="user_id"
                referencedTableName="user"
        />
    </changeSet>

    <changeSet author="isaiah" id="1.0.22">
        <createTable tableName="image">
            <column name="image_id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" unique="true"/>
            </column>
            <column name="asset_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="filename" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="mime" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="data" type="LONGBLOB">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="isaiah" id="1.0.23">
        <addForeignKeyConstraint
                baseColumnNames="asset_id"
                baseTableName="image"
                constraintName="fk_image_asset"
                onDelete="CASCADE"
                onUpdate="RESTRICT"
                referencedColumnNames="asset_id"
                referencedTableName="asset"
        />
    </changeSet>

</databaseChangeLog>